<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebNovel ‚Äî Single-file Full App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thumb{max-width:100%;height:auto;display:block}
    .scroll-y{max-height:40vh;overflow:auto}
    .tiny{font-size:12px}
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">WebNovel ‚Äî Local Full App</h1>
      <div class="flex items-center gap-3">
        <div id="auth-area" class="flex items-center gap-2"></div>
        <button id="toggle-theme" class="px-3 py-1 border rounded">üåô</button>
      </div>
    </header>

    <body>
  <header>
    <nav style="background:#111; padding:10px;">
      <a href="profile.html" style="color:white; margin-right:10px;">Trang ch·ªß</a>
      <a href="profile.html" style="color:white;">H·ªì s∆° c·ªßa t√¥i</a>
    </nav>
  </header>

  <!-- ph·∫ßn n·ªôi dung web ·ªü d∆∞·ªõi -->
    </body>

    <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Left: Library -->
      <aside class="col-span-1 bg-white dark:bg-slate-800 border rounded p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Th∆∞ vi·ªán</h2>
          <div class="text-xs text-slate-500">Local-only</div>
        </div>
        <div class="mb-3 flex gap-2">
          <input id="searchStories" placeholder="T√¨m truy·ªán..." class="flex-1 border rounded px-2 py-1 bg-transparent" />
          <button id="btnNewStory" class="px-3 py-1 bg-sky-600 text-white rounded">T·∫°o</button>
        </div>
        <div id="storiesList" class="space-y-2 scroll-y pr-2"></div>
        <hr class="my-3" />
        <div class="text-sm text-slate-500">
          L∆∞u tr·ªØ: <span id="storageUsage">‚Äî</span>
        </div>
      </aside>

      <!-- Right: Reader / Editor -->
      <section class="col-span-1 lg:col-span-3 bg-white dark:bg-slate-800 border rounded p-4">
        <div id="pageArea"></div>
      </section>
    </main>

    <footer class="mt-6 text-xs text-slate-500">·ª®ng d·ª•ng ch·∫°y ho√†n to√†n tr√™n tr√¨nh duy·ªát (localStorage). ƒê·ªÉ s·∫£n xu·∫•t c·∫ßn backend + DB + object storage.</footer>
  </div>

  <!-- Templates -->
  <template id="storyCardTpl">
    <div class="p-2 rounded-md flex items-start gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer">
      <div class="w-12 h-12 bg-slate-100 dark:bg-slate-700 rounded overflow-hidden flex-shrink-0">
        <img class="w-full h-full object-cover cover-img" src="" alt="cover" />
      </div>
      <div class="flex-1">
        <div class="font-medium story-title"></div>
        <div class="text-xs text-slate-500 story-author"></div>
        <div class="text-xs text-slate-400 story-meta mt-1"></div>
      </div>
      <div class="flex flex-col items-end gap-1">
        <button class="btnFollow px-2 py-1 border rounded text-sm">Theo d√µi</button>
        <div class="text-xs text-slate-400"> <button class="btnEdit text-xs text-sky-600">S·ª≠a</button> ‚Ä¢ <button class="btnDelete text-xs text-red-500">X√≥a</button></div>
      </div>
    </div>
  </template>

  <script>
    const LS_KEY = '__webnovel_v2';

    function defaultData(){
      return {
        users: [ { id: 'u-admin', username: 'admin', email: 'admin@local', password: 'admin', role: 'admin', avatar: '' } ],
        stories: [],
        follows: [],
        comments: [],
        bookmarks: [],
        reports: []
      };
    }

    let DATA = loadData();
    let CURRENT_USER = null;
    const PAGE = document.getElementById('pageArea');
    const STORIES_LIST = document.getElementById('storiesList');

    function loadData(){ try{ const raw = localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):defaultData(); }catch(e){console.error(e); return defaultData();} }
    function saveData(){ localStorage.setItem(LS_KEY, JSON.stringify(DATA)); updateStorageUsage(); }
    function uid(prefix='id'){ return prefix+'-'+Date.now()+'-'+Math.floor(Math.random()*90000+10000); }
    function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    function updateStorageUsage(){ try{ const size=new Blob([localStorage.getItem(LS_KEY)||'']).size; document.getElementById('storageUsage').textContent=(size/1024).toFixed(1)+' KB'; }catch(e){} }

    function renderAuthArea(){ const root=document.getElementById('auth-area'); root.innerHTML=''; if(CURRENT_USER){ const el=document.createElement('div'); el.className='flex items-center gap-2'; const av=document.createElement('div'); av.className='w-8 h-8 rounded-full bg-slate-200 overflow-hidden'; const img=document.createElement('img'); img.src=CURRENT_USER.avatar||'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#cbd5e1"/></svg>`); img.className='w-full h-full object-cover'; av.appendChild(img); el.appendChild(av); const name=document.createElement('div'); name.textContent=CURRENT_USER.username; name.className='text-sm'; el.appendChild(name); const btn=document.createElement('button'); btn.textContent='ƒêƒÉng xu·∫•t'; btn.className='px-2 py-1 border rounded text-sm'; btn.onclick=()=>{ CURRENT_USER=null; renderAll(); }; el.appendChild(btn); root.appendChild(el); } else { const l=document.createElement('button'); l.textContent='ƒêƒÉng nh·∫≠p'; l.className='px-3 py-1 border rounded'; l.onclick=showLogin; const r=document.createElement('button'); r.textContent='ƒêƒÉng k√Ω'; r.className='px-3 py-1 border rounded'; r.onclick=showRegister; root.appendChild(l); root.appendChild(r); } }

    function renderStories(filter=''){ STORIES_LIST.innerHTML=''; const tpl=document.getElementById('storyCardTpl'); const list=DATA.stories.filter(s=>s.title.toLowerCase().includes(filter.toLowerCase())); if(list.length===0){ STORIES_LIST.innerHTML='<div class="text-sm text-slate-500">Kh√¥ng c√≥ truy·ªán</div>'; return; } list.forEach(s=>{ const node=tpl.content.cloneNode(true); node.querySelector('.cover-img').src=s.cover||'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="240" height="160"><rect width="100%" height="100%" fill="#e2e8f0"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="18" fill="#606677">No cover</text></svg>`); node.querySelector('.story-title').textContent=s.title; node.querySelector('.story-author').textContent=s.author||'T√°c gi·∫£ ·∫©n'; const chapCount = (s.volumes||[]).reduce((a,v)=>a+(v.chapters?.length||0),0); node.querySelector('.story-meta').textContent=`${s.volumes?.length||0} t·∫≠p ‚Ä¢ ${chapCount} ch∆∞∆°ng`; const btnFollow=node.querySelector('.btnFollow'); btnFollow.textContent = DATA.follows.some(f=>f.userId===CURRENT_USER?.id && f.storyId===s.id)?'ƒê√£ theo':'Theo d√µi'; btnFollow.onclick=(e)=>{ e.stopPropagation(); if(!CURRENT_USER){ alert('C·∫ßn ƒëƒÉng nh·∫≠p'); return; } toggleFollow(s.id); }; node.querySelector('.btnEdit').onclick=(e)=>{ e.stopPropagation(); if(!canEdit(s)) return alert('Kh√¥ng c√≥ quy·ªÅn'); showEditStory(s.id); }; node.querySelector('.btnDelete').onclick=(e)=>{ e.stopPropagation(); if(!canDelete(s)) return alert('Kh√¥ng c√≥ quy·ªÅn'); if(confirm('X√≥a truy·ªán?')){ DATA.stories = DATA.stories.filter(x=>x.id!==s.id); saveData(); renderStories(document.getElementById('searchStories').value); renderMainEmpty(); } }; node.querySelector('div').onclick=(e)=>{ if(e.target.closest('.btnFollow')||e.target.closest('.btnEdit')||e.target.closest('.btnDelete')) return; openStoryPage(s.id); }; STORIES_LIST.appendChild(node); }); }

    function toggleFollow(storyId){ if(!CURRENT_USER) return; const idx=DATA.follows.findIndex(f=>f.userId===CURRENT_USER.id && f.storyId===storyId); if(idx===-1) DATA.follows.push({id:uid('f'),userId:CURRENT_USER.id,storyId,createdAt:Date.now()}); else DATA.follows.splice(idx,1); saveData(); renderStories(document.getElementById('searchStories').value); }

    function canEdit(story){ if(!CURRENT_USER) return false; if(CURRENT_USER.role==='admin') return true; return story.authorId===CURRENT_USER.id; }
    function canDelete(story){ return canEdit(story); }

    function renderMainEmpty(){ PAGE.innerHTML=`<div class="p-4 text-slate-500">Ch·ªçn truy·ªán ƒë·ªÉ xem ho·∫∑c t·∫°o truy·ªán m·ªõi.</div>`; }

    function openStoryPage(storyId){ const s = DATA.stories.find(x=>x.id===storyId); if(!s) return; PAGE.innerHTML=''; const top=document.createElement('div'); top.className='flex items-start gap-4 mb-4'; const cover=document.createElement('img'); cover.src=s.cover; cover.className='w-48 h-32 object-cover rounded'; top.appendChild(cover); const md=document.createElement('div'); md.className='flex-1'; md.innerHTML=`<h2 class="text-xl font-semibold">${s.title}</h2><div class="text-sm text-slate-500">${s.author||'T√°c gi·∫£ ·∫©n'}</div><div class="mt-2 text-sm text-slate-700 dark:text-slate-300">${s.summary||''}</div>`; const actions=document.createElement('div'); actions.className='flex flex-col gap-2'; const btnRead=document.createElement('button'); btnRead.textContent='ƒê·ªçc'; btnRead.className='px-3 py-1 bg-sky-600 text-white rounded'; btnRead.onclick=()=>openReader(s.id); const btnEdit=document.createElement('button'); btnEdit.textContent='S·ª≠a truy·ªán'; btnEdit.className='px-3 py-1 border rounded'; btnEdit.onclick=()=>showEditStory(s.id); actions.appendChild(btnRead); actions.appendChild(btnEdit); top.appendChild(md); top.appendChild(actions); PAGE.appendChild(top);

      const volWrap=document.createElement('div'); volWrap.className='mb-4'; const hb=document.createElement('div'); hb.className='flex items-center justify-between mb-2'; hb.innerHTML=`<div class='font-medium'>T·∫≠p</div><div><button id='btnNewVolume' class='px-2 py-1 border rounded text-sm'>T·∫°o t·∫≠p</button></div>`; volWrap.appendChild(hb); const volList=document.createElement('div'); volList.className='space-y-2'; (s.volumes||[]).forEach(vol=>{ const v=document.createElement('div'); v.className='p-2 border rounded'; v.innerHTML=`<div class='flex items-center justify-between'><div><div class='font-semibold'>${vol.title}</div><div class='text-xs text-slate-500'>${vol.chapters.length} ch∆∞∆°ng</div></div><div><button class='btnAddChapter px-2 py-1 border rounded text-sm'>Th√™m ch∆∞∆°ng</button></div></div>`; v.querySelector('.btnAddChapter').onclick=()=>showAddChapter(s.id, vol.id); const chList=document.createElement('div'); chList.className='mt-2 space-y-1'; vol.chapters.forEach(ch=>{ const c=document.createElement('div'); c.className='flex items-center justify-between text-sm'; c.innerHTML=`<div class='cursor-pointer'>${ch.title}</div><div class='text-xs'><button class='btnOpen text-sky-600'>M·ªü</button> <button class='btnDel text-red-500'>X√≥a</button></div>`; c.querySelector('.btnOpen').onclick=()=>openChapterPage(s.id, vol.id, ch.id); c.querySelector('.btnDel').onclick=()=>{ if(confirm('X√≥a ch∆∞∆°ng?')){ vol.chapters=vol.chapters.filter(x=>x.id!==ch.id); saveData(); openStoryPage(s.id); } }; chList.appendChild(c); }); v.appendChild(chList); volList.appendChild(v); }); volWrap.appendChild(volList); PAGE.appendChild(volWrap);

      document.getElementById('btnNewVolume').onclick = ()=>{ const title = prompt('Ti√™u ƒë·ªÅ t·∫≠p m·ªõi:')||`T·∫≠p ${ (s.volumes?.length||0)+1 }`; const vid = uid('vol'); s.volumes = s.volumes||[]; s.volumes.push({id:vid,title,chapters:[]}); saveData(); openStoryPage(s.id); };
    }

    function openReader(storyId, chapterId=null){ const s = DATA.stories.find(x=>x.id===storyId); if(!s) return; let vol=null; let ch=null; for(const v of (s.volumes||[])){ for(const c of (v.chapters||[])){ if(!chapterId){ if(!vol){ vol=v; ch=c; break; } } if(c.id===chapterId){ vol=v; ch=c; break; } } if(ch) break; }
      PAGE.innerHTML=''; const top=document.createElement('div'); top.className='flex items-center justify-between mb-3'; top.innerHTML=`<div><div class='text-sm text-slate-500'>${s.title} ‚Ä¢ ${vol?vol.title:''} ‚Ä¢ ${ch?ch.title:''}</div></div><div class='flex gap-2'><button id='btnFontMinus' class='px-2 py-1 border rounded'>A-</button><button id='btnFontPlus' class='px-2 py-1 border rounded'>A+</button><button id='btnToggleImages' class='px-2 py-1 border rounded'>·∫¢nh</button></div>`; PAGE.appendChild(top);
      const art=document.createElement('article'); art.className='border rounded p-6 bg-white dark:bg-slate-800'; art.style.fontSize='18px'; art.style.lineHeight='1.8'; art.innerHTML = formatContent(ch?.content||'(Ch∆∞a c√≥ n·ªôi dung)'); PAGE.appendChild(art);
      const imgsDiv=document.createElement('div'); imgsDiv.className='mt-4 grid grid-cols-2 gap-2'; (ch?.images||[]).forEach(im=>{ const i=document.createElement('img'); i.src=im.data; i.alt=im.caption||''; i.className='thumb rounded'; imgsDiv.appendChild(i); }); PAGE.appendChild(imgsDiv);
      let imagesVisible=true; document.getElementById('btnToggleImages').onclick=()=>{ imagesVisible=!imagesVisible; imgsDiv.style.display = imagesVisible? 'grid':'none'; };
      document.getElementById('btnFontMinus').onclick=()=>{ const fs = parseInt(art.style.fontSize)||18; art.style.fontSize = Math.max(12,fs-2)+'px'; };
      document.getElementById('btnFontPlus').onclick=()=>{ const fs = parseInt(art.style.fontSize)||18; art.style.fontSize = Math.min(32,fs+2)+'px'; };

      const cmWrap = document.createElement('div'); cmWrap.className='mt-6 border rounded p-4 bg-white dark:bg-slate-800'; cmWrap.innerHTML = `<h3 class='font-medium mb-2'>B√¨nh lu·∫≠n</h3><div id='commentsList' class='space-y-2'></div><div class='mt-3'><textarea id='newComment' class='w-full border rounded px-2 py-2' rows=3 placeholder='Vi·∫øt b√¨nh lu·∫≠n...'></textarea><div class='flex items-center gap-2 mt-2'><button id='btnPostComment' class='px-3 py-1 bg-sky-600 text-white rounded'>ƒêƒÉng</button><div class='text-xs text-slate-400'>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n</div></div></div>`; PAGE.appendChild(cmWrap);
      renderComments(ch?.id);
      document.getElementById('btnPostComment').onclick=()=>{ if(!CURRENT_USER){ alert('C·∫ßn ƒëƒÉng nh·∫≠p'); return; } const content = document.getElementById('newComment').value.trim(); if(!content) return alert('N·ªôi dung r·ªóng'); DATA.comments.push({id:uid('com'), userId:CURRENT_USER.id, chapterId: ch.id, parentId:null, content, createdAt:Date.now()}); saveData(); renderComments(ch.id); document.getElementById('newComment').value=''; };
    }

    function renderComments(chapterId){ const wrap = document.getElementById('commentsList'); wrap.innerHTML=''; const topComments = DATA.comments.filter(c=>c.chapterId===chapterId && !c.parentId).sort((a,b)=>a.createdAt-b.createdAt); topComments.forEach(c=>{ const u = DATA.users.find(x=>x.id===c.userId); const block = document.createElement('div'); block.className='p-2 border rounded'; block.innerHTML = `<div class='flex items-start gap-3'><div class='w-8 h-8 rounded-full bg-slate-200 overflow-hidden'><img src='${u?.avatar||''}' class='w-full h-full object-cover' /></div><div class='flex-1'><div class='text-sm'><strong>${u?.username||'·∫®n'}</strong> <span class='tiny text-slate-400'>${new Date(c.createdAt).toLocaleString()}</span></div><div class='mt-1 text-sm text-slate-700 dark:text-slate-300'>${escapeHtml(c.content)}</div><div class='mt-2 text-xs text-slate-500'><button class='btnReply'>Tr·∫£ l·ªùi</button> <button class='btnReport text-red-500'>B√°o</button> ${ (CURRENT_USER && (CURRENT_USER.role==='admin' || CURRENT_USER.id===c.userId)) ? '<button class="btnDeleteComment text-red-600">X√≥a</button>':'' }</div><div class='replies mt-2 ml-6'></div></div></div>`;
        block.querySelector('.btnReply').onclick = ()=>{ const area = document.createElement('div'); area.innerHTML = `<textarea class='w-full border rounded p-2 mt-2' rows=2></textarea><div class='flex gap-2 mt-2'><button class='px-2 py-1 bg-sky-600 text-white rounded btnSendReply'>G·ª≠i</button><button class='px-2 py-1 border rounded btnCancelReply'>H·ªßy</button></div>`; block.querySelector('div.flex-1').appendChild(area); block.querySelector('.btnCancelReply').onclick=()=>area.remove(); block.querySelector('.btnSendReply').onclick=()=>{ const val = area.querySelector('textarea').value.trim(); if(!val) return; if(!CURRENT_USER){ alert('C·∫ßn ƒëƒÉng nh·∫≠p'); return; } DATA.comments.push({id:uid('com'), userId:CURRENT_USER.id, chapterId:chapterId, parentId:c.id, content:val, createdAt:Date.now()}); saveData(); renderComments(chapterId); } };
        block.querySelector('.btnReport').onclick = ()=>{ if(!CURRENT_USER){ alert('C·∫ßn ƒëƒÉng nh·∫≠p'); return; } const reason = prompt('L√Ω do b√°o c√°o (t√πy ch·ªçn):')||''; DATA.reports.push({id:uid('r'), reporterId:CURRENT_USER.id, targetType:'comment', targetId:c.id, reason, status:'open', createdAt:Date.now()}); saveData(); alert('ƒê√£ g·ª≠i b√°o c√°o'); };
        const delBtn = block.querySelector('.btnDeleteComment'); if(delBtn){ delBtn.onclick=()=>{ if(!confirm('X√≥a b√¨nh lu·∫≠n?')) return; DATA.comments = DATA.comments.filter(x=>x.id!==c.id && x.parentId!==c.id); saveData(); renderComments(chapterId); } }
        const repliesWrap = block.querySelector('.replies'); const replies = DATA.comments.filter(r=>r.parentId===c.id); replies.forEach(r=>{ const ur = DATA.users.find(x=>x.id===r.userId); const rb = document.createElement('div'); rb.className='p-1'; rb.innerHTML = `<div class='text-sm'><strong>${ur?.username||'·∫®n'}</strong> <span class='tiny text-slate-400'>${new Date(r.createdAt).toLocaleString()}</span></div><div class='text-sm text-slate-700 dark:text-slate-300'>${escapeHtml(r.content)}</div>`; repliesWrap.appendChild(rb); });
        wrap.appendChild(block);
      });
    }

    function openChapterPage(storyId, volumeId, chapterId){ const s = DATA.stories.find(x=>x.id===storyId); const v = s.volumes.find(x=>x.id===volumeId); const ch = v.chapters.find(x=>x.id===chapterId); PAGE.innerHTML=''; PAGE.innerHTML = `<div class='mb-2'><button id='btnBackStory' class='px-2 py-1 border rounded'>Quay l·∫°i</button></div><h2 class='text-xl font-semibold mb-2'>${ch.title}</h2><div class='mb-4 text-sm text-slate-500'>${s.title} ‚Ä¢ ${v.title}</div><article class='border rounded p-4 bg-white dark:bg-slate-800' style='line-height:1.8'>${formatContent(ch.content)}</article>`; document.getElementById('btnBackStory').onclick=()=>openStoryPage(storyId); }

    function showAddChapter(storyId, volumeId){ const s = DATA.stories.find(x=>x.id===storyId); const v = s.volumes.find(x=>x.id===volumeId); PAGE.innerHTML=''; const form=document.createElement('div'); form.className='space-y-3'; form.innerHTML = `<input id='chTitle' class='w-full border rounded px-2 py-2' placeholder='Ti√™u ƒë·ªÅ ch∆∞∆°ng' /><textarea id='chContent' class='w-full border rounded px-2 py-2' rows=8 placeholder='N·ªôi dung (Markdown/HTML)'></textarea><input id='chImages' type='file' accept='image/*' multiple /><div class='flex gap-2'><button id='saveCh' class='px-3 py-1 bg-sky-600 text-white rounded'>L∆∞u ch∆∞∆°ng</button><button id='cancelCh' class='px-3 py-1 border rounded'>H·ªßy</button></div>`; PAGE.appendChild(form); document.getElementById('cancelCh').onclick=()=>openStoryPage(storyId); document.getElementById('saveCh').onclick=async ()=>{ const title=document.getElementById('chTitle').value.trim()||`Ch∆∞∆°ng ${ (v.chapters||[]).length+1 }`; const content=document.getElementById('chContent').value; const files = document.getElementById('chImages').files; const images=[]; for(const f of files){ const data = await readFileAsDataURL(f); images.push({id:uid('img'), data, caption: f.name}); } v.chapters = v.chapters||[]; v.chapters.push({id:uid('ch'), title, content, images}); saveData(); openStoryPage(storyId); }; }

    function showEditStory(storyId){ const s = DATA.stories.find(x=>x.id===storyId) || { id:null, title:'', author:CURRENT_USER?.username||'', summary:'', cover:'', volumes:[] } ; PAGE.innerHTML=''; const form=document.createElement('div'); form.className='space-y-3'; form.innerHTML = `<div class='grid grid-cols-1 md:grid-cols-3 gap-3'><div class='md:col-span-1'><div class='text-sm font-medium mb-1'>Cover</div><div class='w-full h-40 bg-slate-100 dark:bg-slate-700 rounded overflow-hidden'><img id='coverPreview' class='thumb' src='${s.cover||''}' /></div><input id='inpCover' type='file' accept='image/*' class='mt-2' /></div><div class='md:col-span-2 space-y-2'><input id='inpTitle' class='w-full border rounded px-2 py-2' placeholder='Ti√™u ƒë·ªÅ' value='${s.title||''}' /><input id='inpAuthor' class='w-full border rounded px-2 py-2' placeholder='T√°c gi·∫£' value='${s.author||CURRENT_USER?.username||''}' /><textarea id='inpSummary' class='w-full border rounded px-2 py-2' rows='4' placeholder='T√≥m t·∫Øt'>${s.summary||''}</textarea><div class='flex gap-2'><button id='saveStory' class='px-3 py-1 bg-sky-600 text-white rounded'>L∆∞u</button><button id='cancelStory' class='px-3 py-1 border rounded'>H·ªßy</button></div></div></div>`; PAGE.appendChild(form);
      document.getElementById('inpCover').onchange = async (e)=>{ const f=e.target.files[0]; if(!f) return; const b=await readFileAsDataURL(f); document.getElementById('coverPreview').src=b; };
      document.getElementById('cancelStory').onclick = ()=>{ if(s.id) openStoryPage(s.id); else renderMainEmpty(); };
      document.getElementById('saveStory').onclick = ()=>{ const title=document.getElementById('inpTitle').value.trim(); if(!title) return alert('Ti√™u ƒë·ªÅ r·ªóng'); const author=document.getElementById('inpAuthor').value.trim()||'·∫®n danh'; const summary=document.getElementById('inpSummary').value.trim(); const cover=document.getElementById('coverPreview').src||''; if(s.id){ s.title=title; s.author=author; s.summary=summary; s.cover=cover; saveData(); openStoryPage(s.id); renderStories(document.getElementById('searchStories').value); } else { if(!CURRENT_USER) return alert('C·∫ßn ƒëƒÉng nh·∫≠p'); const id=uid('story'); DATA.stories.unshift({id,title,author,authorId:CURRENT_USER.id,summary,cover,volumes:[]}); saveData(); renderStories(document.getElementById('searchStories').value); openStoryPage(id); } };
    }

    function showRegister(){ PAGE.innerHTML=`<div class='max-w-md'><h2 class='text-lg font-semibold mb-2'>ƒêƒÉng k√Ω</h2><input id='regUser' class='w-full border rounded px-2 py-2 mb-2' placeholder='T√™n ƒëƒÉng nh·∫≠p' /><input id='regEmail' class='w-full border rounded px-2 py-2 mb-2' placeholder='Email' /><input id='regPass' type='password' class='w-full border rounded px-2 py-2 mb-2' placeholder='M·∫≠t kh·∫©u' /><div class='flex gap-2'><button id='btnReg' class='px-3 py-1 bg-sky-600 text-white rounded'>ƒêƒÉng k√Ω</button><button id='btnCancelReg' class='px-3 py-1 border rounded'>H·ªßy</button></div></div>`; document.getElementById('btnCancelReg').onclick=()=>renderAll(); document.getElementById('btnReg').onclick=()=>{ const u=document.getElementById('regUser').value.trim(); const e=document.getElementById('regEmail').value.trim(); const p=document.getElementById('regPass').value; if(!u||!e||!p) return alert('ƒêi·ªÅn ƒë·ªß th√¥ng tin'); if(DATA.users.find(x=>x.username===u)) return alert('T√™n ƒë√£ c√≥'); const id=uid('u'); DATA.users.push({id,username:u,email:e,password:p,role:'user',avatar:''}); saveData(); alert('ƒêƒÉng k√Ω xong, ƒëƒÉng nh·∫≠p ngay'); showLogin(); }; }

    function showLogin(){ PAGE.innerHTML=`<div class='max-w-md'><h2 class='text-lg font-semibold mb-2'>ƒêƒÉng nh·∫≠p</h2><input id='logUser' class='w-full border rounded px-2 py-2 mb-2' placeholder='T√™n ƒëƒÉng nh·∫≠p ho·∫∑c email' /><input id='logPass' type='password' class='w-full border rounded px-2 py-2 mb-2' placeholder='M·∫≠t kh·∫©u' /><div class='flex gap-2'><button id='btnLog' class='px-3 py-1 bg-sky-600 text-white rounded'>ƒêƒÉng nh·∫≠p</button><button id='btnCancelLog' class='px-3 py-1 border rounded'>H·ªßy</button></div></div>`; document.getElementById('btnCancelLog').onclick=()=>renderAll(); document.getElementById('btnLog').onclick=()=>{ const u=document.getElementById('logUser').value.trim(); const p=document.getElementById('logPass').value; const user = DATA.users.find(x=>x.username===u||x.email===u); if(!user||user.password!==p) return alert('Sai th√¥ng tin'); CURRENT_USER = {id:user.id, username:user.username, role:user.role, avatar:user.avatar}; renderAll(); alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng'); }; }

    function showAdminReports(){ PAGE.innerHTML=''; const list = DATA.reports; PAGE.innerHTML = `<h2 class='text-xl font-semibold mb-3'>B√°o c√°o (${list.length})</h2><div id='repList' class='space-y-2'></div>`; const wrap=document.getElementById('repList'); list.forEach(r=>{ const block=document.createElement('div'); block.className='p-2 border rounded'; block.innerHTML=`<div class='tiny text-slate-500'>${new Date(r.createdAt).toLocaleString()} ‚Ä¢ ${r.targetType} ${r.targetId}</div><div class='mt-1'>${r.reason||'<i>Kh√¥ng ghi</i>'}</div><div class='mt-2'><button class='px-2 py-1 border rounded btnResolve'>Gi·∫£i quy·∫øt</button> <button class='px-2 py-1 border rounded btnDelete'>X√≥a m·ª•c ƒë∆∞·ª£c b√°o</button></div>`; block.querySelector('.btnResolve').onclick=()=>{ r.status='resolved'; saveData(); showAdminReports(); }; block.querySelector('.btnDelete').onclick=()=>{ if(r.targetType==='comment'){ DATA.comments = DATA.comments.filter(c=>c.id!==r.targetId && c.parentId!==r.targetId); } saveData(); showAdminReports(); }; wrap.appendChild(block); }); }

    function formatContent(raw){ const esc = escapeHtml(raw); return esc.split(/\n\n+/).map(x=>`<p>${x.replace(/\n/g,'<br>')}</p>`).join(''); }
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'\n'); }

    document.getElementById('btnNewStory').onclick = ()=>{ if(!CURRENT_USER){ alert('C·∫ßn ƒëƒÉng nh·∫≠p'); showLogin(); return; } showEditStory(null); };
    document.getElementById('searchStories').oninput = (e)=>renderStories(e.target.value);
    document.getElementById('toggle-theme').onclick = ()=>{ document.body.classList.toggle('dark'); document.getElementById('toggle-theme').textContent = document.body.classList.contains('dark')? '‚òÄÔ∏è':'üåô'; };

    function renderAll(){ renderAuthArea(); renderStories(document.getElementById('searchStories').value||''); renderMainEmpty(); updateStorageUsage(); }

    if(DATA.stories.length===0){ const sid = uid('story'); DATA.stories.push({ id:sid, title:'H·ªìi ·ª©c trong m∆∞a', author:'T√°c gi·∫£ ·∫®n', authorId: DATA.users[0].id, summary:'Truy·ªán demo', cover:'', volumes:[{id:uid('vol'), title:'T·∫≠p 1', chapters:[{id:uid('ch'), title:'Ch∆∞∆°ng 1', content:'Ng√†y m∆∞a b·∫Øt ƒë·∫ßu nh·∫π nh√†ng...', images:[] }]}] }); saveData(); }

    renderAll();

    const checkAdminInterval = setInterval(()=>{ if(CURRENT_USER && CURRENT_USER.role==='admin'){ if(!document.getElementById('adminReportsBtn')){ const btn = document.createElement('button'); btn.id='adminReportsBtn'; btn.textContent='B√°o c√°o'; btn.className='px-3 py-1 border rounded'; btn.onclick=showAdminReports; document.getElementById('auth-area').appendChild(btn);} } },800);

  </script>
</body>
</html>
