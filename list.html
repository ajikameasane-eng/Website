<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tạo Truyện</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#ffffff;--card:#ffffff;--muted:#6b7280;--border:#e5e7eb;--accent:#111827}
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  body{margin:0;background:var(--bg);color:var(--accent);line-height:1.5}
  .container{max-width:1100px;margin:28px auto;padding:20px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .title{font-weight:700;font-size:20px}
  .top-actions{display:flex;gap:10px;align-items:center}
  .btn{background:#111;color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .btn.light{background:#fff;color:#111;border:1px solid var(--border)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px}
  .grid{display:grid;gap:14px}
  .cols-3{grid-template-columns:320px 1fr 320px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:14px}
  textarea{min-height:120px;resize:vertical}
  .stories-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .story-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:8px;border:1px solid var(--border);cursor:pointer}
  .cover{width:72px;height:72px;background:#f3f4f6;border-radius:6px;object-fit:cover}
  .meta{flex:1}
  .story-title{font-weight:600}
  .story-sub{font-size:13px;color:var(--muted);margin-top:4px}
  .small{font-size:13px;color:var(--muted)}
  .right-column{display:flex;flex-direction:column;gap:12px}
  .section-title{font-weight:600;margin-bottom:8px}
  .reader-area{padding:12px}
  .chapter-card{padding:10px;border:1px dashed var(--border);border-radius:8px;margin-bottom:8px}
  .chapter-content{padding:16px;border-radius:8px;background:#fff;border:1px solid var(--border);margin-top:12px}
  .nav-ch{display:flex;justify-content:space-between;margin-top:12px;gap:10px}
  .avatar{width:36px;height:36px;border-radius:999px;object-fit:cover}
  .link{color:#111;text-decoration:none}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  @media (max-width:900px){ .cols-3{grid-template-columns:1fr} .right-column{order:3} }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="title">Asane's Library</div>
    <div class="top-actions">
      <button id="btnProfile" class="btn light">Hồ sơ</button>
      <button id="btnExport" class="btn light">Export JSON</button>
      <button id="btnImport" class="btn light">Import JSON</button>
      <button id="btnClear" class="btn light">Xóa dữ liệu</button>
    </div>
  </header>

  <div class="grid cols-3">
    <aside class="card">
      <div class="section-title">Thêm truyện mới</div>
      <label>Tiêu đề</label>
      <input id="inpTitle" type="text" placeholder="Tên truyện" />
      <label>Tóm tắt</label>
      <textarea id="inpSummary" placeholder="Tóm tắt ngắn"></textarea>
      <label>Ảnh bìa</label>
      <input id="inpCover" type="file" accept="image/*" />
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="btnAddStory" class="btn">Tạo truyện</button>
        <button id="btnResetForm" class="btn light">Mới</button>
      </div>
      <div class="small" style="margin-top:12px">Dữ liệu lưu trong trình duyệt (localStorage).</div>
    </aside>

    <main>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:600">Danh sách truyện</div>
          <input id="search" type="text" placeholder="Tìm truyện..." style="padding:6px;border:1px solid var(--border);border-radius:8px" />
        </div>
        <div id="storiesList" class="stories-list"></div>
      </div>

      <div id="mainPanel" class="card" style="margin-top:14px;display:none"></div>
    </main>

    <aside class="right-column">
      <div class="card">
        <div style="display:flex;align-items:center;gap:10px">
          <img id="hdrAvatar" class="avatar" src="" alt="avatar" />
          <div>
            <div id="hdrName" style="font-weight:600">Người dùng</div>
            <div class="small" id="hdrBio">Chưa có mô tả</div>
          </div>
        </div>
        <div style="margin-top:10px">
          <button id="btnOpenProfile" class="btn light">Xem chỉnh sửa hồ sơ</button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Gợi ý nhanh</div>
        <div class="small">• Tạo truyện bằng form bên trái.</div>
        <div class="small">• Chọn truyện để vào trang chi tiết, thêm tập & chương.</div>
      </div>
    </aside>
  </div>

  <footer>Asane's Library • Local demo • Lưu trên trình duyệt</footer>
</div>

<div id="profileModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;padding:20px">
  <div style="width:100%;max-width:520px;background:#fff;padding:18px;border-radius:10px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:700">Hồ sơ của tôi</div>
      <button id="closeProfile" class="btn light">Đóng</button>
    </div>
    <div style="display:flex;gap:12px">
      <div style="width:120px">
        <img id="profAvatarPreview" src="" style="width:120px;height:120px;border-radius:8px;object-fit:cover;border:1px solid var(--border)" />
        <input id="profAvatarFile" type="file" accept="image/*" style="margin-top:8px" />
      </div>
      <div style="flex:1">
        <label style="font-size:13px;color:var(--muted)">Tên hiển thị</label>
        <input id="profName" type="text" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px" />
        <label style="font-size:13px;color:var(--muted);margin-top:8px;display:block">Mô tả</label>
        <textarea id="profBio" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px" rows=4></textarea>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="saveProfileBtn" class="btn">Lưu</button>
          <button id="cancelProfileBtn" class="btn light">Hủy</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const LS = '__asane_library_v1';
let DB = load();
let currentUser = ensureDemoUser();
let selectedStoryId = null;

function save(){ localStorage.setItem(LS, JSON.stringify(DB)); renderAll(); }
function load(){ try{ return JSON.parse(localStorage.getItem(LS)) || seeded(); }catch(e){return seeded();} }
function seeded(){
  const adminId = 'u-'+Date.now();
  return { users:[{id:adminId,username:'Admin',bio:'Tác giả demo',avatar:''}], stories:[], follows:[], comments:[] };
}
function ensureDemoUser(){
  if(!DB.users || DB.users.length===0) DB = seeded();
  const u = DB.users[0];
  currentUser = { id: u.id, username: u.username, role: 'admin', avatar: u.avatar || '' };
  document.getElementById('hdrName').textContent = u.username;
  document.getElementById('hdrBio').textContent = u.bio || 'Chưa có mô tả';
  document.getElementById('hdrAvatar').src = u.avatar || blankAvatar();
  return currentUser;
}
function blankAvatar(){ return 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="#e5e7eb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="20">A</text></svg>'); }

document.getElementById('btnAddStory').onclick = async ()=>{
  const title = document.getElementById('inpTitle').value.trim();
  if(!title){ alert('Cần tiêu đề'); return; }
  const summary = document.getElementById('inpSummary').value.trim();
  let cover = '';
  const f = document.getElementById('inpCover').files[0];
  if(f){ cover = await toDataURL(f); }
  const id = 's-'+Date.now()+'-'+Math.floor(Math.random()*9999);
  DB.stories.unshift({id,title,summary,cover,authorId:currentUser.id,volumes:[]});
  save();
  document.getElementById('inpTitle').value=''; document.getElementById('inpSummary').value=''; document.getElementById('inpCover').value='';
  alert('Tạo truyện xong');
};
document.getElementById('btnResetForm').onclick = ()=>{ document.getElementById('inpTitle').value=''; document.getElementById('inpSummary').value=''; document.getElementById('inpCover').value=''; };
document.getElementById('search').oninput = (e)=> renderStories(e.target.value);
document.getElementById('btnOpenProfile').onclick = ()=> openProfileModal();
document.getElementById('btnProfile').onclick = ()=> openProfileModal();
document.getElementById('closeProfile').onclick = ()=> closeProfileModal();
document.getElementById('cancelProfileBtn').onclick = ()=> closeProfileModal();
document.getElementById('saveProfileBtn').onclick = async ()=>{
  const name = document.getElementById('profName').value.trim(); const bio = document.getElementById('profBio').value.trim();
  if(!name){ alert('Tên không được rỗng'); return; }
  const u = DB.users.find(x=>x.id===currentUser.id);
  u.username = name; u.bio = bio;
  const f = document.getElementById('profAvatarFile').files[0];
  if(f){ u.avatar = await toDataURL(f); }
  save();
  closeProfileModal();
};
document.getElementById('btnExport').onclick = ()=> downloadJSON();
document.getElementById('btnImport').onclick = ()=> triggerImport();
document.getElementById('btnClear').onclick = ()=> { if(confirm('Xóa toàn bộ dữ liệu local?')){ localStorage.removeItem(LS); location.reload(); } };

function openProfileModal(){
  const u = DB.users.find(x=>x.id===currentUser.id);
  document.getElementById('profAvatarPreview').src = u.avatar || blankAvatar();
  document.getElementById('profName').value = u.username || '';
  document.getElementById('profBio').value = u.bio || '';
  document.getElementById('profileModal').style.display = 'flex';
}
function closeProfileModal(){ document.getElementById('profileModal').style.display = 'none'; renderAll(); }
function toDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

function renderAll(){ renderStories(); updateHeader(); renderMainPanel(); }
function updateHeader(){
  const u = DB.users.find(x=>x.id===currentUser.id);
  document.getElementById('hdrName').textContent = u.username;
  document.getElementById('hdrBio').textContent = u.bio || 'Chưa có mô tả';
  document.getElementById('hdrAvatar').src = u.avatar || blankAvatar();
}
function renderStories(filter=''){
  const wrap = document.getElementById('storiesList'); wrap.innerHTML='';
  const list = DB.stories.filter(s=> s.title.toLowerCase().includes((filter||'').toLowerCase()));
  if(list.length===0){ wrap.innerHTML = '<div class="small">Chưa có truyện</div>'; return; }
  list.forEach(s=>{
    const el = document.createElement('div'); el.className='story-item';
    const img = document.createElement('img'); img.className='cover'; img.src = s.cover || blankAvatar();
    const meta = document.createElement('div'); meta.className='meta';
    const t = document.createElement('div'); t.className='story-title'; t.textContent = s.title;
    const sub = document.createElement('div'); sub.className='story-sub'; sub.textContent = s.summary || '';
    meta.appendChild(t); meta.appendChild(sub);
    el.appendChild(img); el.appendChild(meta);
    el.onclick = ()=> openStoryView(s.id);
    wrap.appendChild(el);
  });
}

function renderMainPanel(){
  const panel = document.getElementById('mainPanel');
  if(!selectedStoryId){ panel.style.display='none'; return; }
  panel.style.display='block';
  const s = DB.stories.find(x=>x.id===selectedStoryId);
  if(!s) return;
  panel.innerHTML = '';
  const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
  const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${escapeHtml(s.title)}</div><div class="small" style="margin-top:6px">${escapeHtml(s.summary||'')}</div>`;
  const right = document.createElement('div'); right.innerHTML = `<img src="${s.cover||blankAvatar()}" style="width:120px;height:88px;object-fit:cover;border-radius:8px">`;
  header.appendChild(left); header.appendChild(right); panel.appendChild(header);

  const volWrap = document.createElement('div'); volWrap.style.marginTop='12px';
  const volHeader = document.createElement('div'); volHeader.style.display='flex'; volHeader.style.justifyContent='space-between'; volHeader.style.alignItems='center';
  volHeader.innerHTML = `<div class="section-title">Tập / Chương</div><div><button id="btnAddVolume" class="btn light">➕ Tạo tập</button></div>`;
  volWrap.appendChild(volHeader);

  const vols = document.createElement('div'); vols.style.marginTop='8px';
  (s.volumes||[]).forEach(v=>{
    const vcard = document.createElement('div'); vcard.style.border='1px solid var(--border)'; vcard.style.padding='8px'; vcard.style.borderRadius='8px'; vcard.style.marginBottom='8px';
    vcard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(v.title)}</strong> <div class="small">${v.chapters?.length||0} chương</div></div><div><button class="btn light btnAddChap">Thêm chương</button></div></div>`;
    const chs = document.createElement('div'); chs.style.marginTop='8px';
    (v.chapters||[]).forEach(ch=>{
      const chEl = document.createElement('div'); chEl.className='chapter-card';
      chEl.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(ch.title)}</strong></div><div style="display:flex;gap:8px"><button class="btn light btnRead">Đọc</button><button class="btn light btnDelCh">Xóa</button></div></div>`;
      chEl.querySelector('.btnRead').onclick = (e)=>{ e.stopPropagation(); openChapter(s.id, v.id, ch.id); };
      chEl.querySelector('.btnDelCh').onclick = (e)=>{ e.stopPropagation(); if(confirm('Xóa chương?')){ v.chapters = v.chapters.filter(cc=>cc.id!==ch.id); save(); } };
      chs.appendChild(chEl);
    });
    vcard.appendChild(chs);
    vcard.querySelector('.btnAddChap').onclick = ()=> showAddChapterForm(s.id, v.id);
    vols.appendChild(vcard);
  });

  volWrap.appendChild(vols);
  panel.appendChild(volWrap);

  const bottom = document.createElement('div'); bottom.style.marginTop='12px'; bottom.style.display='flex'; bottom.style.justifyContent='space-between';
  bottom.innerHTML = `<div><button id="btnBack" class="btn light">← Quay lại</button></div><div><button id="btnDeleteStory" class="btn light">Xóa truyện</button></div>`;
  panel.appendChild(bottom);

  document.getElementById('btnBack').onclick = ()=>{ selectedStoryId = null; renderMainPanel(); };
  document.getElementById('btnDeleteStory').onclick = ()=>{ if(confirm('Xóa truyện này?')){ DB.stories = DB.stories.filter(x=>x.id!==s.id); selectedStoryId=null; save(); } };

  document.getElementById('btnAddVolume').onclick = ()=> {
    const title = prompt('Tiêu đề tập:') || `Tập ${ (s.volumes?.length||0)+1 }`;
    const vid = 'v-'+Date.now()+'-'+Math.floor(Math.random()*9999);
    s.volumes = s.volumes||[];
    s.volumes.push({id:vid,title,chapters:[]});
    save();
  };
}

function openStoryView(storyId){
  selectedStoryId = storyId;
  renderMainPanel();
  window.scrollTo({top:document.getElementById('mainPanel').offsetTop-20,behavior:'smooth'});
}

function showAddChapterForm(stId, volId){
  const s = DB.stories.find(x=>x.id===stId);
  const v = s.volumes.find(x=>x.id===volId);
  const title = prompt('Tiêu đề chương:') || `Chương ${ (v.chapters?.length||0)+1 }`;
  const content = prompt('Nội dung chương (dùng \n để xuống dòng):') || '';
  if(content===null) return;
  const input = document.createElement('input'); input.type='file'; input.accept='image/*';
  input.onchange = async (e)=>{
    const f = e.target.files[0];
    const data = f ? await toDataURL(f) : null;
    const ch = { id:'c-'+Date.now()+'-'+Math.floor(Math.random()*9999), title, content, images: data ? [{id:'i-'+Date.now(), data, caption: f.name}] : [] };
    v.chapters = v.chapters||[]; v.chapters.push(ch); save();
  };
  input.click();
}

function openChapter(stId, volId, chId){
  const s = DB.stories.find(x=>x.id===stId);
  const v = s.volumes.find(x=>x.id===volId);
  const ch = v.chapters.find(x=>x.id===chId);
  const panel = document.getElementById('mainPanel'); panel.innerHTML = '';
  const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
  header.innerHTML = `<div><div style="font-weight:700">${escapeHtml(s.title)}</div><div class="small">${escapeHtml(v.title)} • ${escapeHtml(ch.title)}</div></div><div><button id="btnBackToStory" class="btn light">← Quay lại</button></div>`;
  panel.appendChild(header);
  const art = document.createElement('div'); art.className='chapter-content'; art.innerHTML = formatContent(ch.content || '(Trống)');
  panel.appendChild(art);
  if(ch.images && ch.images.length){
    const g = document.createElement('div'); g.style.display='grid'; g.style.gridTemplateColumns='1fr 1fr'; g.style.gap='8px'; g.style.marginTop='12px';
    ch.images.forEach(im=>{ const img = document.createElement('img'); img.src = im.data; img.style.width='100%'; img.style.borderRadius='8px'; g.appendChild(img); });
    panel.appendChild(g);
  }
  const nav = document.createElement('div'); nav.className='nav-ch';
  const idxAll = getAllChaptersIndex(s);
  const idx = idxAll.findIndex(x=>x.volId===volId && x.chId===chId);
  const prev = idx>0 ? idxAll[idx-1] : null;
  const next = idx < idxAll.length-1 ? idxAll[idx+1] : null;
  nav.innerHTML = `<div>${ prev ? `<button id="btnPrevCh" class="btn light">◀ Chương trước</button>` : '' }</div><div>${ next ? `<button id="btnNextCh" class="btn">Chương sau ▶</button>` : '' }</div>`;
  panel.appendChild(nav);
  if(prev) document.getElementById('btnPrevCh').onclick = ()=> openChapter(stId, prev.volId, prev.chId);
  if(next) document.getElementById('btnNextCh').onclick = ()=> openChapter(stId, next.volId, next.chId);
  document.getElementById('btnBackToStory').onclick = ()=> openStoryView(stId);
  window.scrollTo({top:document.getElementById('mainPanel').offsetTop-20,behavior:'smooth'});
}

function getAllChaptersIndex(story){
  const arr=[];
  (story.volumes||[]).forEach(v=>{
    (v.chapters||[]).forEach(ch=> arr.push({volId:v.id,chId:ch.id}));
  });
  return arr;
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
function formatContent(raw){ return escapeHtml(raw).split(/\n\n+/).map(x=>`<p>${x.replace(/\n/g,'<br>')}</p>`).join(''); }

function toDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

function downloadJSON(){ const data = JSON.stringify(DB, null, 2); const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='asane_library_export.json'; a.click(); URL.revokeObjectURL(url); }
function triggerImport(){ const input = document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange = (e)=>{ const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ try{ const d = JSON.parse(r.result); DB = d; save(); alert('Import xong'); }catch(err){ alert('File không hợp lệ'); } }; r.readAsText(f); }; input.click(); }

function renderAll(){ renderStories(); updateHeader(); renderMainPanel(); }
function updateHeader(){ const u = DB.users.find(x=>x.id===currentUser.id); document.getElementById('hdrName').textContent = u.username; document.getElementById('hdrBio').textContent = u.bio || 'Chưa có mô tả'; document.getElementById('hdrAvatar').src = u.avatar || blankAvatar(); }
function openStoryView(storyId){ selectedStoryId = storyId; renderMainPanel(); window.scrollTo({top:document.getElementById('mainPanel').offsetTop-20,behavior:'smooth'}); }

renderAll();
</script>
</body>
</html>
